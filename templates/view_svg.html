<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vps剩余价值计算器</title>
<link rel="preload" href="{{ url_for('static', filename='fonts/JetBrainsMono-Regular.woff2') }}" as="font" type="font/woff2" crossorigin>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/crt.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cards.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/view_svg.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/loading.css') }}">
</head>
<body class="bg-gradient-to-br from-[#0f0f1a] to-[#000000] text-white min-h-screen font-mono flex flex-col">
{% include 'loading_overlay.html' %}
<nav class="banner">
    <a href="{{ url_for('vps_list') }}" class="banner-home">
        <div class="banner-title">
            ⚡ <span>VPS</span> <span>剩余价值计算器</span>
        </div>
        <div class="banner-stats">
            在用主机：<strong>{{ site_stats.count }} 台</strong> / 总价值：<strong>{{ site_stats.total_value }} 元</strong>
        </div>
    </a>
    <div class="banner-subinfo">
        {% if current_user %}
        <span>你好, {{ current_user.username }}</span>
        <a class="text-sm border border-cyan-400 hover:bg-cyan-600 text-cyan-200 hover:text-white px-3 py-1 rounded transition" href="{{ url_for('add_vps') }}">添加 VPS</a>
        <a class="text-sm border border-cyan-400 hover:bg-cyan-600 text-cyan-200 hover:text-white px-3 py-1 rounded transition" href="{{ url_for('manage_vps') }}">管理 VPS</a>
        {% if current_user.is_admin %}
        <a class="text-sm border border-cyan-400 hover:bg-cyan-600 text-cyan-200 hover:text-white px-3 py-1 rounded transition" href="{{ url_for('manage_users') }}">用户管理</a>
        {% endif %}
        <a class="text-sm border border-cyan-400 hover:bg-cyan-600 text-cyan-200 hover:text-white px-3 py-1 rounded transition" href="{{ url_for('logout') }}">退出登录</a>
        {% else %}
        <a class="text-sm border border-cyan-400 hover:bg-cyan-600 text-cyan-200 hover:text-white px-3 py-1 rounded transition" href="{{ url_for('login') }}">登录</a>
        <a class="text-sm border border-cyan-400 hover:bg-cyan-600 text-cyan-200 hover:text-white px-3 py-1 rounded transition" href="{{ url_for('register') }}">注册</a>
        {% endif %}
    </div>
</nav>
<div class="card-container">
    <div class="svg-card">
        <h2 class="text-center text-cyan-300 text-xl mb-4 font-bold">{{ vps.name }}</h2>
        <div class="vps-info-grid">
            <div class="label">商家</div><div>：</div><div>{{ vps.vendor_name or '-' }}</div>
            <div class="label">配置</div><div>：</div><div>{{ specs.cpu }} / {{ specs.memory }} / {{ specs.storage }}</div>
            <div class="label">月流量</div><div>：</div><div>{{ vps.traffic_limit or '-' }}</div>
            <div class="label">IP 地址</div><div>：</div><div class="ip-address">{{ ip_info.flag|twemoji(20,14,'flag-icon') }} {{ ip_info.ip_display }}</div>
            <div class="label">ISP</div><div>：</div><div class="isp-name">{{ ip_info.isp }}</div>
            {% if vps.status != 'sold' and vps.status != 'inactive' %}
            {% set status_parts = ip_info.ping_status.split(' ', 1) %}
            <div class="label">在线状态</div><div>：</div><div><span class="ping-status">{{ status_parts[0]|twemoji(12,12,'status-dot') }} {{ status_parts[1] if status_parts|length > 1 else '' }}</span></div>
            {% endif %}
            <div class="label">到期时间</div><div>：</div><div>{{ data.cycle_end.strftime('%Y/%m/%d') if data.cycle_end else '-' }}</div>
            <div class="label">续费金额</div><div>：</div><div class="vps-price">{{ vps.renewal_price or '-' }} {{ vps.currency }}</div>
            {% if vps.status == 'forsale' %}
            <div class="label">转让溢价</div><div>：</div><div>{{ vps.sale_percent }}%</div>
            <div class="label">固定溢价</div><div>：</div><div>{{ vps.sale_fixed }} 元</div>
            <div class="label">Push 费用</div><div>：</div><div>{{ data.push_fee_cny }} 元</div>
            <div class="label">最终价格</div><div>：</div><div class="vps-price">{{ data.final_price }} 元</div>
            {% endif %}
            <div class="label">描述说明</div><div>：</div><div>{{ vps.description or '-' }}</div>
        </div>
        <div class="vps-card-footer">
            <div class="left-info">
                <div>剩余天数：{{ data.remaining_days }} 天</div>
                <div>剩余价值：{{ data.remaining_value }} 元</div>
                {% if vps.status == 'forsale' %}
                <div>最终价格：{{ data.final_price }} 元</div>
                {% endif %}
            </div>
            <div class="right-info">
                <div>更新时间：{{ today.strftime('%Y/%m/%d') }}</div>
                <div>NodeSeekID：{{ config.username if config and config.username else '' }}</div>
            </div>
        </div>
        <div class="card-buttons">
            <a href="{{ url_for('vps_list') }}">返回列表</a>
            <button id="copyLinkBtn">复制一键发帖</button>
            <a href="{{ url_for('edit_vps', vps_id=vps_id) }}">编辑此项</a>
        </div>
    </div>
</div>
<script>


    document.getElementById('copyLinkBtn').addEventListener('click', function () {
        const encodedUrl = {{ svg_abs_url|tojson }};
        const vendor = {{ (vps.vendor_name or '-')|tojson }};
        const machineName = {{ vps.name|tojson }};
        const status = {{ vps.status|tojson }};

        const info = {};
        document.querySelectorAll('.vps-info-grid .label').forEach(label => {
            const key = label.textContent.trim();
            const value = label.nextElementSibling.nextElementSibling.textContent.trim();
            info[key] = value;
        });

        const leftInfo = {};
        document.querySelectorAll('.left-info div').forEach(div => {
            const parts = div.textContent.split('：');
            if (parts.length === 2) leftInfo[parts[0].trim()] = parts[1].trim();
        });

        const rightInfo = {};
        document.querySelectorAll('.right-info div').forEach(div => {
            const parts = div.textContent.split('：');
            if (parts.length === 2) rightInfo[parts[0].trim()] = parts[1].trim();
        });

        const finalPrice = leftInfo['最终价格'] || info['最终价格'] || '0';
        const fixedPremium = info['固定溢价'] || '0';
        const remainingValue = leftInfo['剩余价值'] || info['剩余价值'] || '0';
        const pushFee = info['Push 费用'] || '0';
        const transferPercentStr = info['转让溢价'] || '0%';
        const transferPercent = parseFloat(transferPercentStr) || 0;
        const percentSign = transferPercent >= 0 ? '+' : '-';
        const fixedPremiumNum = parseFloat(fixedPremium) || 0;
        const fixedSign = fixedPremiumNum >= 0 ? '+' : '-';
        const transferPremiumCny = (
            (parseFloat(remainingValue) + parseFloat(pushFee)) * transferPercent / 100 + fixedPremiumNum
        ).toFixed(2);

        const lines = [];
        lines.push(`[VVC一键发帖]${finalPrice} 出售${vendor}的${machineName} ${info['配置']} ${info['月流量']} 月流量 机器`);
        lines.push('');
        lines.push('[欢迎大家试用VVC（vps-value-calculator）DOCKER部署动态剩余价值计算版](https://github.com/podcctv/vps-value-calculator)');
        lines.push('');
        lines.push(`转让溢价 = （[剩余价值]${remainingValue} + [PUSH费用]${pushFee}） * [转让溢价]${transferPercentStr} + [固定溢价]${fixedPremium} = ${transferPremiumCny} 元`);
        lines.push(`最终价格 = （[剩余价值]${remainingValue} + [PUSH费用]${pushFee}） * （1${percentSign}[转让溢价]${Math.abs(transferPercent)}%）${fixedSign}[固定溢价]${Math.abs(fixedPremiumNum)} = ${finalPrice}`);
        lines.push('');

        lines.push(`## 🟦 [${machineName}] ${vendor} - 出售信息\n`);

        lines.push(`### 📌 基本信息`);
        lines.push(`- **商家**：\`${info['商家']}\``);
        lines.push(`- **配置**：${info['配置']}`);
        lines.push(`- **IP 地址**：${info['IP 地址']}`);
        if (info['在线状态']) lines.push(`- **在线状态**：${info['在线状态']}\n`);

        lines.push(`### 💰 出售信息`);
        lines.push(`- **续费金额**：\`${info['续费金额']}\``);
        lines.push(`- **到期时间**：\`${info['到期时间']}\``);
        if (leftInfo['剩余天数']) lines.push(`- **剩余天数**：${leftInfo['剩余天数']}`);
        if (leftInfo['剩余价值']) lines.push(`- **剩余价值**：${leftInfo['剩余价值']}`);

        if (info['转让溢价'] || info['固定溢价'] || info['Push 费用']) {
            lines.push(`\n### 🔄 转让说明`);
            if (info['转让溢价']) lines.push(`- **转让溢价**：\`${info['转让溢价']}\``);
            if (info['固定溢价']) lines.push(`- **固定溢价**：\`${info['固定溢价']}\``);
            if (info['Push 费用']) lines.push(`- **Push 费用**：\`${info['Push 费用']}\``);
        }

        const statusText = status === 'forsale' ? '待出售 - PUSH' : status;
        lines.push(`> 🟡 状态：**${statusText}**`);
        if (rightInfo['更新时间']) lines.push(`> 📅 更新时间：\`${rightInfo['更新时间']}\``);
        if (rightInfo['NodeSeekID']) lines.push(`> 🆔 NodeSeek ID：\`${rightInfo['NodeSeekID']}\``);

        if (info['描述说明'] && info['描述说明'] !== '-') {
            lines.push(`\n### 📣 说明`);
            lines.push(`- ${info['描述说明']}`);
        }

        lines.push('');
        lines.push(`![image](${encodedUrl})`);

        const text = lines.join('\n');

        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                alert('发帖内容已复制');
            }).catch(() => {
                fallbackCopyText(text);
            });
        } else {
            fallbackCopyText(text);
        }
    });

    function fallbackCopyText(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            if (document.execCommand('copy')) {
                alert('发帖内容已复制');
            } else {
                throw new Error('copy failed');
            }
        } catch (err) {
            alert('复制失败，请手动复制。');
        }
        document.body.removeChild(textArea);
    }
</script>
{% include 'footer.html' %}
</body>
</html>
