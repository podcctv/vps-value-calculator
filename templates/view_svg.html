<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vpså‰©ä½™ä»·å€¼è®¡ç®—å™¨</title>
<link rel="preload" href="{{ url_for('static', filename='fonts/JetBrainsMono-Regular.woff2') }}" as="font" type="font/woff2" crossorigin>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/crt.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cards.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/view_svg.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/loading.css') }}">
</head>
<body class="bg-gradient-to-br from-[#0f0f1a] to-[#000000] text-white min-h-screen font-mono flex flex-col">
{% include 'loading_overlay.html' %}
<nav class="banner">
    <a href="{{ url_for('vps_list') }}" class="banner-home">
        <div class="banner-title">
            âš¡ <span>VPS</span> <span>å‰©ä½™ä»·å€¼è®¡ç®—å™¨</span>
        </div>
        <div class="banner-stats">
            åœ¨ç”¨ä¸»æœºï¼š<strong>{{ site_stats.count }} å°</strong> / æ€»ä»·å€¼ï¼š<strong>{{ site_stats.total_value }} å…ƒ</strong>
        </div>
    </a>
    <div class="banner-subinfo">
        {% if current_user %}
        <span>ä½ å¥½, {{ current_user.username }}</span>
        <a class="text-sm border border-cyan-400 hover:bg-cyan-600 text-cyan-200 hover:text-white px-3 py-1 rounded transition" href="{{ url_for('add_vps') }}">æ·»åŠ  VPS</a>
        <a class="text-sm border border-cyan-400 hover:bg-cyan-600 text-cyan-200 hover:text-white px-3 py-1 rounded transition" href="{{ url_for('manage_vps') }}">ç®¡ç† VPS</a>
        {% if current_user.is_admin %}
        <a class="text-sm border border-cyan-400 hover:bg-cyan-600 text-cyan-200 hover:text-white px-3 py-1 rounded transition" href="{{ url_for('manage_users') }}">ç”¨æˆ·ç®¡ç†</a>
        {% endif %}
        <a class="text-sm border border-cyan-400 hover:bg-cyan-600 text-cyan-200 hover:text-white px-3 py-1 rounded transition" href="{{ url_for('logout') }}">é€€å‡ºç™»å½•</a>
        {% else %}
        <a class="text-sm border border-cyan-400 hover:bg-cyan-600 text-cyan-200 hover:text-white px-3 py-1 rounded transition" href="{{ url_for('login') }}">ç™»å½•</a>
        <a class="text-sm border border-cyan-400 hover:bg-cyan-600 text-cyan-200 hover:text-white px-3 py-1 rounded transition" href="{{ url_for('register') }}">æ³¨å†Œ</a>
        {% endif %}
    </div>
</nav>
<div class="card-container">
    <div class="svg-card">
        <h2 class="text-center text-cyan-300 text-xl mb-4 font-bold">{{ vps.name }}</h2>
        <div class="vps-info-grid">
            <div class="label">å•†å®¶</div><div>ï¼š</div><div>{{ vps.vendor_name or '-' }}</div>
            <div class="label">é…ç½®</div><div>ï¼š</div><div>{{ specs.cpu }} / {{ specs.memory }} / {{ specs.storage }}</div>
            <div class="label">æœˆæµé‡</div><div>ï¼š</div><div>{{ vps.traffic_limit or '-' }}</div>
            <div class="label">IP åœ°å€</div><div>ï¼š</div><div class="ip-address">{{ ip_info.flag|twemoji(20,14,'flag-icon') }} {{ ip_info.ip_display }}</div>
            <div class="label">ISP</div><div>ï¼š</div><div class="isp-name">{{ ip_info.isp }}</div>
            {% set status_parts = ip_info.ping_status.split(' ', 1) %}
            <div class="label">åœ¨çº¿çŠ¶æ€</div><div>ï¼š</div><div><span class="ping-status">{{ status_parts[0]|twemoji(12,12,'status-dot') }} {{ status_parts[1] if status_parts|length > 1 else '' }}</span></div>
            <div class="label">åˆ°æœŸæ—¶é—´</div><div>ï¼š</div><div>{{ data.cycle_end.strftime('%Y/%m/%d') if data.cycle_end else '-' }}</div>
            <div class="label">ç»­è´¹é‡‘é¢</div><div>ï¼š</div><div class="vps-price">{{ vps.renewal_price or '-' }} {{ vps.currency }}</div>
            {% if vps.status == 'forsale' %}
            <div class="label">è½¬è®©æº¢ä»·</div><div>ï¼š</div><div>{{ vps.sale_percent }}%</div>
            <div class="label">å›ºå®šæº¢ä»·</div><div>ï¼š</div><div>{{ vps.sale_fixed }} å…ƒ</div>
            <div class="label">Push è´¹ç”¨</div><div>ï¼š</div><div>{{ data.push_fee_cny }} å…ƒ</div>
            <div class="label">æœ€ç»ˆä»·æ ¼</div><div>ï¼š</div><div class="vps-price">{{ data.final_price }} å…ƒ</div>
            {% endif %}
            <div class="label">æè¿°è¯´æ˜</div><div>ï¼š</div><div>{{ vps.description or '-' }}</div>
        </div>
        <div class="vps-card-footer">
            <div class="left-info">
                <div>å‰©ä½™å¤©æ•°ï¼š{{ data.remaining_days }} å¤©</div>
                <div>å‰©ä½™ä»·å€¼ï¼š{{ data.remaining_value }} å…ƒ</div>
                {% if vps.status == 'forsale' %}
                <div>æœ€ç»ˆä»·æ ¼ï¼š{{ data.final_price }} å…ƒ</div>
                {% endif %}
            </div>
            <div class="right-info">
                <div>æ›´æ–°æ—¶é—´ï¼š{{ today.strftime('%Y/%m/%d') }}</div>
                <div>NodeSeekIDï¼š{{ config.username if config and config.username else '' }}</div>
            </div>
        </div>
        <div class="card-buttons">
            <a href="{{ url_for('vps_list') }}">è¿”å›åˆ—è¡¨</a>
            <button id="copyLinkBtn">å¤åˆ¶ä¸€é”®å‘å¸–</button>
            <a href="{{ url_for('edit_vps', vps_id=vps_id) }}">ç¼–è¾‘æ­¤é¡¹</a>
        </div>
    </div>
</div>
<script>


    document.getElementById('copyLinkBtn').addEventListener('click', function () {
        const encodedUrl = {{ svg_abs_url|tojson }};
        const vendor = {{ (vps.vendor_name or '-')|tojson }};
        const machineName = {{ vps.name|tojson }};
        const status = {{ vps.status|tojson }};

        const info = {};
        document.querySelectorAll('.vps-info-grid .label').forEach(label => {
            const key = label.textContent.trim();
            const value = label.nextElementSibling.nextElementSibling.textContent.trim();
            info[key] = value;
        });

        const leftInfo = {};
        document.querySelectorAll('.left-info div').forEach(div => {
            const parts = div.textContent.split('ï¼š');
            if (parts.length === 2) leftInfo[parts[0].trim()] = parts[1].trim();
        });

        const rightInfo = {};
        document.querySelectorAll('.right-info div').forEach(div => {
            const parts = div.textContent.split('ï¼š');
            if (parts.length === 2) rightInfo[parts[0].trim()] = parts[1].trim();
        });

        const finalPrice = leftInfo['æœ€ç»ˆä»·æ ¼'] || info['æœ€ç»ˆä»·æ ¼'] || '0';
        const fixedPremium = info['å›ºå®šæº¢ä»·'] || '0';
        const remainingValue = leftInfo['å‰©ä½™ä»·å€¼'] || info['å‰©ä½™ä»·å€¼'] || '0';
        const pushFee = info['Push è´¹ç”¨'] || '0';
        const transferPercentStr = info['è½¬è®©æº¢ä»·'] || '0%';
        const transferPercent = parseFloat(transferPercentStr) || 0;
        const percentSign = transferPercent >= 0 ? '+' : '-';
        const fixedPremiumNum = parseFloat(fixedPremium) || 0;
        const fixedSign = fixedPremiumNum >= 0 ? '+' : '-';
        const transferPremiumCny = (
            (parseFloat(remainingValue) + parseFloat(pushFee)) * transferPercent / 100 + fixedPremiumNum
        ).toFixed(2);

        const lines = [];
        lines.push(`[VVCä¸€é”®å‘å¸–]${finalPrice} å‡ºå”®${vendor}çš„${machineName} ${info['é…ç½®']} ${info['æœˆæµé‡']} æœˆæµé‡ æœºå™¨`);
        lines.push('');
        lines.push('[æ¬¢è¿å¤§å®¶è¯•ç”¨VVCï¼ˆvps-value-calculatorï¼‰DOCKERéƒ¨ç½²åŠ¨æ€å‰©ä½™ä»·å€¼è®¡ç®—ç‰ˆ](https://github.com/podcctv/vps-value-calculator)');
        lines.push('');
        lines.push(`è½¬è®©æº¢ä»· = ï¼ˆ[å‰©ä½™ä»·å€¼]${remainingValue} + [PUSHè´¹ç”¨]${pushFee}ï¼‰ * [è½¬è®©æº¢ä»·]${transferPercentStr} + [å›ºå®šæº¢ä»·]${fixedPremium} = ${transferPremiumCny} å…ƒ`);
        lines.push(`æœ€ç»ˆä»·æ ¼ = ï¼ˆ[å‰©ä½™ä»·å€¼]${remainingValue} + [PUSHè´¹ç”¨]${pushFee}ï¼‰ * ï¼ˆ1${percentSign}[è½¬è®©æº¢ä»·]${Math.abs(transferPercent)}%ï¼‰${fixedSign}[å›ºå®šæº¢ä»·]${Math.abs(fixedPremiumNum)} = ${finalPrice}`);
        lines.push('');

        lines.push(`## ğŸŸ¦ [${machineName}] ${vendor} - å‡ºå”®ä¿¡æ¯\n`);

        lines.push(`### ğŸ“Œ åŸºæœ¬ä¿¡æ¯`);
        lines.push(`- **å•†å®¶**ï¼š\`${info['å•†å®¶']}\``);
        lines.push(`- **é…ç½®**ï¼š${info['é…ç½®']}`);
        lines.push(`- **IP åœ°å€**ï¼š${info['IP åœ°å€']}`);
        lines.push(`- **åœ¨çº¿çŠ¶æ€**ï¼š${info['åœ¨çº¿çŠ¶æ€']}\n`);

        lines.push(`### ğŸ’° å‡ºå”®ä¿¡æ¯`);
        lines.push(`- **ç»­è´¹é‡‘é¢**ï¼š\`${info['ç»­è´¹é‡‘é¢']}\``);
        lines.push(`- **åˆ°æœŸæ—¶é—´**ï¼š\`${info['åˆ°æœŸæ—¶é—´']}\``);
        if (leftInfo['å‰©ä½™å¤©æ•°']) lines.push(`- **å‰©ä½™å¤©æ•°**ï¼š${leftInfo['å‰©ä½™å¤©æ•°']}`);
        if (leftInfo['å‰©ä½™ä»·å€¼']) lines.push(`- **å‰©ä½™ä»·å€¼**ï¼š${leftInfo['å‰©ä½™ä»·å€¼']}`);

        if (info['è½¬è®©æº¢ä»·'] || info['å›ºå®šæº¢ä»·'] || info['Push è´¹ç”¨']) {
            lines.push(`\n### ğŸ”„ è½¬è®©è¯´æ˜`);
            if (info['è½¬è®©æº¢ä»·']) lines.push(`- **è½¬è®©æº¢ä»·**ï¼š\`${info['è½¬è®©æº¢ä»·']}\``);
            if (info['å›ºå®šæº¢ä»·']) lines.push(`- **å›ºå®šæº¢ä»·**ï¼š\`${info['å›ºå®šæº¢ä»·']}\``);
            if (info['Push è´¹ç”¨']) lines.push(`- **Push è´¹ç”¨**ï¼š\`${info['Push è´¹ç”¨']}\``);
        }

        const statusText = status === 'forsale' ? 'å¾…å‡ºå”® - PUSH' : status;
        lines.push(`> ğŸŸ¡ çŠ¶æ€ï¼š**${statusText}**`);
        if (rightInfo['æ›´æ–°æ—¶é—´']) lines.push(`> ğŸ“… æ›´æ–°æ—¶é—´ï¼š\`${rightInfo['æ›´æ–°æ—¶é—´']}\``);
        if (rightInfo['NodeSeekID']) lines.push(`> ğŸ†” NodeSeek IDï¼š\`${rightInfo['NodeSeekID']}\``);

        if (info['æè¿°è¯´æ˜'] && info['æè¿°è¯´æ˜'] !== '-') {
            lines.push(`\n### ğŸ“£ è¯´æ˜`);
            lines.push(`- ${info['æè¿°è¯´æ˜']}`);
        }

        lines.push('');
        lines.push(`![image](${encodedUrl})`);

        const text = lines.join('\n');

        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                alert('å‘å¸–å†…å®¹å·²å¤åˆ¶');
            }).catch(() => {
                fallbackCopyText(text);
            });
        } else {
            fallbackCopyText(text);
        }
    });

    function fallbackCopyText(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            if (document.execCommand('copy')) {
                alert('å‘å¸–å†…å®¹å·²å¤åˆ¶');
            } else {
                throw new Error('copy failed');
            }
        } catch (err) {
            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
        }
        document.body.removeChild(textArea);
    }
</script>
{% include 'footer.html' %}
</body>
</html>
